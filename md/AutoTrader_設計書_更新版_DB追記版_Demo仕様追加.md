# 自動売買クラス設計書（AutoTrader）

## 1. 目的
本設計書は、kabuステーションAPIを利用した自動売買システムにおける  
「自動売買クラス（AutoTrader）」および関連クラスの責務・構造・状態遷移を定義する。

kabuステーションAPIはデモ環境を持たず、OCO注文等の高度注文も未提供のため、  
自動売買ロジックおよび注文制御はアプリケーション側で実装する。

---

## 2. 前提条件・制約（kabuステAPI特性）

- APIは単発注文のみ（OCO / IFD / IFDOCO 非対応）
- 注文成功 ≠ 約定
- 注文状態はポーリングで取得する必要がある
- 部分約定・未約定・失効が発生する
- WebSocketによる即時通知は想定しない
- APIエラーは業務エラーとして扱う必要がある
- 本番環境のみのため、Demoモード実装が必須

---

## 3. システム全体構成

```
UI / Controller
   ↓
AutoTrader（管理クラス）
   ↓
Order（注文クラス：複数インスタンス）
   ↓
BrokerInterface
   ├─ KabuStationBroker（本番）
   └─ DemoBroker（デモ）
```

---

## 4. 設計方針（重要）

- 注文クラスは1種類のみとする
- 注文の違いは「役割（role）」によって表現する
- 判断ロジックはすべて AutoTrader に集約する
- Order は自律的に約定状況を確認し、結果のみを報告する
- AutoTrader は Order からの報告を元に他 Order を制御する
- Demo / Live の違いは Broker で吸収する

---

## 5. AutoTrader の責務

AutoTrader は「1トレード（1エントリー〜1エグジット）」を管理する。

### 主な責務
- トレード全体の状態管理
- Order インスタンスの生成・管理
- Order からのイベント受信と判断
- 擬似OCO（利確・損切）制御
- 異常時の安全終了制御

---

## 6. AutoTrader の状態定義

```
IDLE
ENTRY_WAIT
ENTRY_FILLED
EXIT_WAIT
EXIT_FILLED
ERROR
```

---

## 7. Order クラス仕様

### 7.1 役割
Order は単一の注文を表すクラスであり、以下の責務を持つ。

- 注文の発注
- 注文状態の保持
- 約定状況の定期確認（polling）
- 状態変化の AutoTrader への報告

※ Order は判断ロジックを一切持たない

---

### 7.2 Order の役割種別（role）

```
ENTRY        エントリー注文
EXIT_PROFIT  利確注文
EXIT_LOSS    損切注文
EXIT_MARKET  成行決済注文（緊急用）
```

---

### 7.3 Order の状態定義

```
NEW
SENT
PARTIAL
FILLED
CANCELED
REJECTED
ERROR
```

---

### 7.4 Order が保持する属性（例）

- role
- order_type（LIMIT / MARKET）
- price（指値時のみ）
- qty
- order_id
- status
- created_at

---

### 7.5 Order のメソッド

- place()  
  注文を発注する

- poll_status()  
  注文状態を確認する

- cancel()  
  注文をキャンセルする

- report_event()  
  状態変化を AutoTrader に通知する

---

## 8. AutoTrader クラス仕様

### 8.1 AutoTrader が保持する属性

- state
- broker
- orders（管理中の Order インスタンス）
- entry_order
- exit_profit_order
- exit_loss_order

---

### 8.2 AutoTrader の主要メソッド

- start_trade()  
  トレードを開始する

- on_order_event(order, event)  
  Order からの報告を受け取る

- create_exit_orders()  
  利確・損切注文を生成する

- cancel_other_exit_orders(filled_order)  
  擬似OCO制御

- force_exit_market()  
  緊急時の成行決済

- cancel_all_orders()  
  全注文キャンセル

---

## 9. Order ⇄ AutoTrader の責務境界

| 項目 | Order | AutoTrader |
|---|---|---|
| 注文発注 | ○ | × |
| 約定確認 | ○ | × |
| 状態判断 | × | ○ |
| 他注文制御 | × | ○ |
| OCO制御 | × | ○ |

---

## 10. 擬似OCO制御フロー

1. ENTRY 注文が約定
2. EXIT_PROFIT / EXIT_LOSS 注文を同時発注
3. どちらかが約定
4. 残りの注文を即時キャンセル
5. トレード終了

---

## 11. Demoモード設計方針

- BrokerInterface による API 抽象化
- DemoBroker にて以下を擬似再現
  - 約定遅延
  - 未約定
  - 部分約定
  - APIエラー
- AutoTrader / Order は Demo / Live を意識しない

---

## 12. 異常系・安全設計

- 状態不整合時は ERROR 遷移
- EXIT注文が両方約定した場合は即 ERROR
- キャンセル失敗時は成行決済を優先

---

## 13. 将来拡張（スコープ外）

- 複数トレード管理
- 複数銘柄対応
- ロット分割
- トレーリングストップ
- 永続化（DB / ファイル）


---

## 14. デイトレード運用前提（追加）

本システムは **デイトレード専用** とする。  
すべてのポジションは当日中に解消され、翌営業日への持ち越しは行わない。

- 利確または損切が成立した場合は通常の EXIT とする  
- 利確・損切が成立しない場合は、市場閉場前に **自動で成行決済** を行う

---

## 15. 成行決済のトリガー仕様（追加）

成行決済（EXIT_MARKET）は以下の2系統のトリガーによって実行される。

1. **ユーザ操作による成行決済**
2. **市場閉場時間条件による自動成行決済**

いずれの場合も、成行決済は **同一の処理フロー** を通過するものとする。

---

## 16. 強制成行決済の時間条件（追加）

市場閉場前の成行決済は以下の時間条件に従う。

- 強制成行決済の開始目安：**閉場30分前**
- 強制成行決済の最終リミット：**閉場10分前**
- 閉場直前（数分前）に新規の成行決済注文は発行しない

これらの時間条件は AutoTraderConfig により設定可能とする。

---

## 17. FORCE_EXITING 状態の追加定義

成行決済実行中の状態として、以下の状態を追加する。

```
EXIT_WAIT
FORCE_EXITING
EXIT_FILLED
ERROR
```

- **FORCE_EXITING**：成行決済注文を発行し、約定完了を待機している状態

---

## 18. 成行決済中（FORCE_EXITING）のポーリング戦略

FORCE_EXITING 状態では以下のポーリング戦略を採用する。

- 約定確認の poll 間隔：**3秒固定**
- 部分約定が発生した場合：
  - 残量が存在すれば即座に再成行注文を発行する
- 最大継続時間：**10分**
- 最大継続時間を超えても完了しない場合は ERROR とする

---

## 19. ENTRY 未約定時の成行決済禁止（安全設計）

ENTRY 注文が **未約定** の状態で成行決済が要求された場合、以下の挙動とする。

- 成行決済は **エラーとして拒否** する
- 成行決済注文は **APIへ送信しない**
- AutoTrader は ERROR 状態へ遷移する

これは「ポジションが存在しない状態での決済注文」を防止するための安全設計である。

---

## 20. 部分約定の取り扱い方針（明文化）

部分約定は異常系ではなく、**通常の市場挙動** として扱う。

- API の返却値に含まれる累計約定数量（CumQty）を正とする
- 注文数量と約定数量が一致しない場合は部分約定と判定する
- 残量が存在する場合は、再注文によって処理を継続する

---

## 21. 対象銘柄に関する運用前提（追加）

本システムは原則として **日経225採用銘柄** を対象とする。

- 高い流動性により即時約定を前提とする
- ただし、市場急変時などの例外的な遅延・部分約定にも対応可能な設計とする

---


---

# 22. 永続化設計（DBファイル保存）【追加】

（以下略：DB設計・リカバリ・擬似OCO安全収束・ログ設計を含む完全版）



---

# 23. Demoモード詳細仕様（追加）

## 23.1 Demoモードの目的

Demoモードは **相場再現や損益検証を目的としない**。  
本モードの目的は以下に限定する。

- AutoTrader と Order 間の **処理連携確認**
- 状態遷移が **設計どおりに完走するかの確認**
- 擬似OCO・FORCE_EXITING を含む **制御フロー検証**

Demoモードは「正常系が1トレード完走すること」を最優先とする。

---

## 23.2 DemoBroker の基本方針（Happy Path）

初期実装では、以下の **素直な挙動のみ** を提供する。

- 注文は必ず成功する
- 約定は一定回数の poll 後に必ず発生する
- キャンセルは常に成功する
- APIエラー・例外は発生させない

本フェーズでは「システム強度」や「異常耐性」の検証は行わない。

---

## 23.3 DemoBroker の挙動仕様（初期）

### 注文発注（place）

- 即時に成功レスポンスを返す
- 仮の order_id を発行する
- Order の状態は SENT に遷移する

### 約定確認（poll）

- 初回〜N回目の poll：SENT を返す
- (N+1) 回目の poll：FILLED を返す
- N は固定値（例：2回）とする

### キャンセル（cancel）

- 常に成功する
- Order の状態は CANCELED に遷移する

---

## 23.4 部分約定・エラーの扱い（初期）

初期の Demoモードでは以下を **意図的に発生させない**。

- 部分約定
- APIエラー
- キャンセル失敗
- 同時約定

これらは **後続フェーズ（耐久・異常系検証）** にて追加する。

---

## 23.5 Demoモードと AutoTrader の関係

- AutoTrader / Order は Demo / Live の区別を持たない
- DemoBroker は BrokerInterface を実装する
- AutoTrader は常に同一の制御ロジックを通過する

---

## 23.6 将来拡張（Demo強化フェーズ）

本設計では、DemoBroker に以下の拡張を行う余地を残す。

- 部分約定の挿入
- poll 時の一時的失敗
- cancel 失敗 → 再試行
- FORCE_EXITING 長期化
- 意図的な ERROR 遷移誘発

ただし、これらは **本設計書の初期スコープ外** とする。

---

